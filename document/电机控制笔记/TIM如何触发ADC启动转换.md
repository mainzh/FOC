# TIM1 CH4 PWM通道触发ADC转换的时机分析

* 为什么需要外部触发的方式进行ADC的采集转换：最主要的目的是能精确的采集相电流
  在栅极驱动电路行成回路(电机三相线圈有电流)，即PWM高电平占空比50%时间点，启动ADC转换





# 🔍 STM32 定时器 5 种 Counter Mode 详解

STM32 定时器的计数器模式决定了计数器的计数方向和对齐方式，共包含以下 5 种：

------

#### 1. **Up（向上计数模式）**

- **工作原理**：计数器从 `0` 开始递增，直到达到自动重装寄存器（`ARR`）的值，然后溢出并回到 `0`，重新开始计数。
- **触发时机**：更新事件（`Update Event`）在计数器溢出时产生。
- **典型应用**：产生定时中断、PWM 信号（边沿对齐模式）。

------

#### 2. **Down（向下计数模式）**

- **工作原理**：计数器从自动重装寄存器（`ARR`）的值开始递减，直到减到 `0`，然后溢出并重新加载 `ARR` 的值，再次开始递减。
- **触发时机**：更新事件在计数器下溢时产生。
- **典型应用**：需要从最大值开始倒计时的场景。

------

#### 3. **Center Aligned mode 1（中心对齐模式 1）**

- **工作原理**：计数器先从 `0` 递增到 `ARR-1`，产生更新事件；然后从 `ARR` 递减到 `1`，再次产生更新事件。
- **触发时机**：更新事件发生在递增阶段的溢出和递减阶段的下溢时。
- **特点**：PWM 信号的边沿在计数周期的中心对齐，适合需要对称波形的应用（如电机控制）。

------

#### 4. **Center Aligned mode 2（中心对齐模式 2）**

- **工作原理**：计数器先从 `0` 递增到 `ARR`，产生更新事件；然后从 `ARR-1` 递减到 `0`，再次产生更新事件。
- **触发时机**：更新事件发生在递增阶段的溢出和递减阶段的下溢时。
- **特点**：与模式 1 的区别在于更新事件的触发点不同，适用于对时序要求更精确的对称 PWM 生成。

------

#### 5. **Center Aligned mode 3（中心对齐模式 3）**

- **工作原理**：计数器先从 `0` 递增到 `ARR`，产生更新事件；然后从 `ARR` 递减到 `1`，再次产生更新事件。
- **触发时机**：更新事件发生在递增阶段的溢出和递减阶段的下溢时。
- **特点**：结合了模式 1 和模式 2 的触发特性，提供更灵活的中心对齐 PWM 生成方式。

# 两种 PWM 模式

## 1. **PWM mode 1**

- **核心原理**：向上计数时，当定时器的计数值 `CNT` < 比较值 `CCR`，通道输出有效电平；当 `CNT` ≥ `CCR`，输出无效电平。
- 周期与占空比：
  - 周期由 `ARR`（自动重装载值）决定，公式为：周期 = (ARR + 1) × 定时器时钟周期
  - 占空比由 `CCR`（捕获比较寄存器）决定，公式为：占空比 = CCR / (ARR + 1)
- 在你的配置中：
  - 通道 3 和 3N 配置为 `PWM mode 1`，极性 `High`，意味着有效电平是高电平。
  - 当 `CNT < CCR` 时，输出高电平；`CNT ≥ CCR` 时，输出低电平。
  - `Pulse = 0` 意味着 `CCR = 0`，所以这个通道会一直输出低电平。

## 2. **PWM mode 2**

- **核心原理**：向上计数时，当定时器的计数值 `CNT` < 比较值 `CCR`，通道输出无效电平；当 `CNT ≥ CCR`，输出有效电平。
- 周期与占空比：
  - 周期同样由 `ARR` 决定
  - 占空比公式为：占空比 = (ARR + 1 - CCR) / (ARR + 1)
- 在你的配置中：
  - 通道 4 配置为 `PWM mode 2`，极性 `High`，意味着有效电平是高电平。
  - 当 `CNT < CCR` 时，输出低电平；`CNT ≥ CCR` 时，输出高电平。
  - `Pulse = HALF_PWM_PERIOD_CYCLES - 2`，说明这个通道的占空比被设置为接近半周期的反向波形。

## 模式对比表

|     特性     |    PWM mode 1     |       PWM mode 2        |
| :----------: | :---------------: | :---------------------: |
| 有效电平条件 |    `CNT < CCR`    |       `CNT ≥ CCR`       |
| 无效电平条件 |    `CNT ≥ CCR`    |       `CNT < CCR`       |
|  占空比公式  |  `CCR / (ARR+1)`  | `(ARR+1-CCR) / (ARR+1)` |
|   典型用途   | 普通正向 PWM 输出 | 反向 PWM 输出、互补驱动 |

# 使用Center Aligned mode 2生成PWM

$PWM\_FREQUENCY = \frac{PWM\_TIMER\_CLK}{(PSC+1)(ARR+1)}$

PWM_FREQUENCY--PWM频率----------(20KHz)

PWM_TIMER_CLK-------------定时器时钟频率--(168MHz)

Prescaler (PSC - 16 bits value) --预分频寄存器--(1-1)

Counter Period (AutoReload Register - 16 bits value)--自动重装载值寄存器--(PWM_PERIOD_CYCLES-1)

```c
// PWM输出的目标频率，单位：Hz（赫兹），20kHz
PWM_FREQUENCY      20000u
    
// TIM定时器的时钟频率，单位：Hz（赫兹），168MHz
PWM_TIMER_CLK      168000000u
    
// 计算PWM周期对应的定时器计数值（ARR寄存器值）
// 核心公式：周期计数值 = 定时器时钟频率 / PWM目标频率
PWM_PERIOD_CYCLES  (uint16_t)(PWM_TIMER_CLK/PWM_FREQUENCY)
    
// 计算PWM周期的一半计数值（用于50%占空比、中心对齐模式等场景）
// 2U：U表示无符号数，避免除法运算的符号问题
HALF_PWM_PERIOD_CYCLES  (uint16_t)(PWM_PERIOD_CYCLES / 2U)
```

Prescaler (PSC - 16 bits value) ：1-1    // PSC = 0，实际分频系数`PSC_DIV = PSC + 1 = 1`

Counter Period (AutoReload Register - 16 bits value)：